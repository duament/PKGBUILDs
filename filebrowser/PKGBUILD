# Maintainer: Duama <admin@duama.top>

pkgname=filebrowser
pkgver=2.16.1
pkgrel=1
pkgdesc='Web File Browser'
arch=(x86_64)
url='https://github.com/filebrowser/filebrowser'
license=(Apache)
depends=(glibc)
makedepends=(npm go go.rice)
source=("$pkgname-$pkgver.tar.gz::https://github.com/$pkgname/$pkgname/archive/v$pkgver.tar.gz"
        "$pkgname@.service")
sha256sums=('e1d145f8a01a6b901cc93b986fde3114911b7faf07860f1cfe812b8a7f34c3ea'
            '31ec64a8e47b33dac958caaf9bedb1c3d3052194007f770d4c05228d4301bddc')

prepare() {
    cd $pkgname-$pkgver

    # Front end
    cd frontend
    npm install
    cd ..
}

build() {
    cd $pkgname-$pkgver

    # Front end
    cd frontend
    npm run build
    cd ..

    # Back end
    cd http
    rice embed-go
    cd ..

    export CGO_CPPFLAGS="$CPPFLAGS"
    export CGO_CFLAGS="$CFLAGS"
    export CGO_CXXFLAGS="$CXXFLAGS"
    export CGO_LDFLAGS="$LDFLAGS"
    export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"
    go build .
}

package() {
    install -Dm755 $pkgname-$pkgver/$pkgname "$pkgdir"/usr/bin/$pkgname
    install -Dm744 $pkgname@.service "$pkgdir"/usr/lib/systemd/system/$pkgname@.service
}
